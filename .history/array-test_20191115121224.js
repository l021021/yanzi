// EUI64 - D0CF5EFFFE793466 - 3 - Motion, mo, 1573537459421


var RecordArray = [{ "type": "samplemotion", "Did": "EUI64-D0CF5EFFFE59F50A-3-Motion", "timeStamp": 1573716686657, "value": "ot" }, { "type": "samplemotion", "Did": "EUI64-D0CF5EFFFE793F2F-3-Motion", "timeStamp": 1573716692123, "value": "ot" }, { "type": "samplemotion", "Did": "EUI64-D0CF5EFFFE793F2F-3-Motion", "timeStamp": 1573716695094, "value": "ot" }, { "type": "samplemotion", "Did": "EUI64-90FD9FFFFEA93984-3-Motion", "timeStamp": 1573716709140, "value": "ot" }, { "type": "samplemotion", "Did": "EUI64-D0CF5EFFFE59F4C5-3-Motion", "timeStamp": 1573716714543, "value": "ot" }, { "type": "samplemotion", "Did": "EUI64-D0CF5EFFFE79326A-3-Motion", "timeStamp": 1573716722632, "value": "ot" }, { "type": "samplemotion", "Did": "EUI64-D0CF5EFFFE7B22CA-3-Motion", "timeStamp": 1573716732339, "value": "ot" }, { "type": "samplemotion", "Did": "EUI64-90FD9FFFFEA93984-3-Motion", "timeStamp": 1573716733065, "value": "ot" }, { "type": "samplemotion", "Did": "EUI64-D0CF5EFFFE59F5C1-3-Motion", "timeStamp": 1573716736220, "value": "in" }, { "type": "samplemotion", "Did": "EUI64-D0CF5EFFFE793F2F-3-Motion", "timeStamp": 1573716736249, "value": "ot" }, { "type": "samplemotion", "Did": "EUI64-D0CF5EFFFE59E6E2-3-Motion", "timeStamp": 1573716736942, "value": "in" }, { "type": "samplemotion", "Did": "EUI64-D0CF5EFFFE792BF4-3-Motion", "timeStamp": 1573716743846, "value": "ot" }, { "type": "samplemotion", "Did": "EUI64-D0CF5EFFFE793267-3-Motion", "timeStamp": 1573716747211, "value": "in" }, { "type": "samplemotion", "Did": "EUI64-D0CF5EFFFE793F2F-3-Motion", "timeStamp": 1573716747613, "value": "ot" }, { "type": "samplemotion", "Did": "EUI64-D0CF5EFFFE69E1D5-3-Motion", "timeStamp": 1573716754655, "value": "in" }, { "type": "samplemotion", "Did": "EUI64-D0CF5EFFFE69E206-3-Motion", "timeStamp": 1573716755924, "value": "ot" }, { "type": "samplemotion", "Did": "EUI64-D0CF5EFFFE7B22CA-3-Motion", "timeStamp": 1573716757470, "value": "in" }, { "type": "samplemotion", "Did": "EUI64-D0CF5EFFFE69E206-3-Motion", "timeStamp": 1573716758759, "value": "in" }, { "type": "samplemotion", "Did": "EUI64-D0CF5EFFFE59F4C5-3-Motion", "timeStamp": 1573716759375, "value": "in" }, { "type": "samplemotion", "Did": "EUI64-D0CF5EFFFE59F50A-3-Motion", "timeStamp": 1573716759425, "value": "in" }, { "type": "samplemotion", "Did": "EUI64-D0CF5EFFFE59E61D-3-Motion", "timeStamp": 1573716760851, "value": "in" }, { "type": "samplemotion", "Did": "EUI64-D0CF5EFFFE793466-3-Motion", "timeStamp": 1573716766646, "value": "in" }, { "type": "samplemotion", "Did": "EUI64-D0CF5EFFFE793466-3-Motion", "timeStamp": 1573716767677, "value": "ot" }, { "type": "samplemotion", "Did": "EUI64-90FD9FFFFEA78027-3-Motion", "timeStamp": 1573716772925, "value": "ot" }, { "type": "samplemotion", "Did": "EUI64-D0CF5EFFFE792BF4-3-Motion", "timeStamp": 1573716779035, "value": "in" }, { "type": "samplemotion", "Did": "EUI64-D0CF5EFFFE59E61D-3-Motion", "timeStamp": 1573716780874, "value": "ot" }, { "type": "samplemotion", "Did": "EUI64-D0CF5EFFFE793F2F-3-Motion", "timeStamp": 1573716781332, "value": "in" }, { "type": "samplemotion", "Did": "EUI64-D0CF5EFFFE793A07-3-Motion", "timeStamp": 1573716781536, "value": "ot" }, { "type": "samplemotion", "Did": "EUI64-D0CF5EFFFE59E61D-3-Motion", "timeStamp": 1573716781850, "value": "ot" }, { "type": "samplemotion", "Did": "EUI64-D0CF5EFFFE793F2F-3-Motion", "timeStamp": 1573716782877, "value": "ot" }, { "type": "samplemotion", "Did": "EUI64-D0CF5EFFFE793F2F-3-Motion", "timeStamp": 1573716784400, "value": "ot" }, { "type": "samplemotion", "Did": "EUI64-90FD9FFFFEA77C58-3-Motion", "timeStamp": 1573716785388, "value": "in" }, { "type": "samplemotion", "Did": "EUI64-90FD9FFFFEA77C58-3-Motion", "timeStamp": 1573716786413, "value": "ot" }, { "type": "samplemotion", "Did": "EUI64-90FD9FFFFEA780B9-3-Motion", "timeStamp": 1573716789230, "value": "ot" }, { "type": "samplemotion", "Did": "EUI64-90FD9FFFFEA95938-3-Motion", "timeStamp": 1573716789375, "value": "ot" }, { "type": "samplemotion", "Did": "EUI64-D0CF5EFFFE793166-3-Motion", "timeStamp": 1573716803228, "value": "ot" }, { "type": "samplemotion", "Did": "EUI64-D0CF5EFFFE108F63-3-Motion", "timeStamp": 1573716803379, "value": "ot" }, { "type": "samplemotion", "Did": "EUI64-D0CF5EFFFE59F5C1-3-Motion", "timeStamp": 1573716806196, "value": "in" }, { "type": "samplemotion", "Did": "EUI64-D0CF5EFFFE59F50A-3-Motion", "timeStamp": 1573716806808, "value": "ot" }, { "type": "samplemotion", "Did": "EUI64-D0CF5EFFFE59E66C-3-Motion", "timeStamp": 1573716807031, "value": "ot" }, { "type": "samplemotion", "Did": "EUI64-D0CF5EFFFE59F106-3-Motion", "timeStamp": 1573716807157, "value": "in" }, { "type": "samplemotion", "Did": "EUI64-D0CF5EFFFE69DFA4-3-Motion", "timeStamp": 1573716807431, "value": "in" }, { "type": "samplemotion", "Did": "EUI64-D0CF5EFFFE59DFB8-3-Motion", "timeStamp": 1573716809035, "value": "in" }]


//console.log(RecordArray);
var t1 = new Date();
var t2 = new Date();
var t1m = new Date();
var timeArray = new Array();
var timeObj = {
        "ID": '',
        "timeStamp": '',
        "Value": ''
    }
    //var t1s = new Date();
var t = new Date();
var t2m = new Date();
//t2s = new Date();

var minDiff, Aftert1, Beforet2;

for (let i = 1; i < RecordArray.length; i++) { //start from Second element 

    t1.setTime(RecordArray[i - 1].timeStamp);
    t1m.setTime(RecordArray[i - 1].timeStamp); //t1m：靠近后一个整分
    t1m.setMilliseconds(0);
    t1m.setSeconds(0); //second=0
    t1.setMilliseconds(0); //取整数秒

    t2.setTime(RecordArray[i].timeStamp);
    t2m.setTime(RecordArray[i].timeStamp); //t1m：靠近前一个整分
    t2m.setMilliseconds(0);
    t2m.setSeconds(0); //second=0
    t2.setMilliseconds(0); //milli =0


    //得到分钟差和秒数零头

    minDiff = Math.floor((t2m - t1m) / 60 / 1000);
    t1ToNext = 60 - t1.getSeconds();
    PrevTot2 = t2.getSeconds();


    //var timeDiff=RecordArray[i].timeStamp-RecordArray[i-1].timeStamp;
    console.log(t1.toLocaleTimeString() + '-前  ' + t1m.toLocaleTimeString() + '  ' + minDiff + '  ' + t1ToNext + ' ' + PrevTot2 + '   ' + t2.toLocaleTimeString() + '-后  ' + t2m.toLocaleTimeString());

    if (RecordArray[i].value == 'in' && RecordArray[i - 1].value == 'in') { //全部=1
        //process head
        t = t.setTime(t1m - 60 * 1000); //Previous

        let _RecordExist = false;
        let _ExistValue = 0;

        //var tt = TimeArray[t.toLocaleTimeString()] || 0;//TODO

        console.log(t.toLocaleTimeString());
        for (const key in timeArray) { //already exits in Array?

            if (timeArray[key].timeStamp == t.toLocaleTimeString()) {
                _RecordExist = true;
                _ExistValue = timeArray[key].Value;
            }
        }

        { //HEAD
            timeObj.timeStamp = t;
            timeObj.value = _ExistValue + t1ToNext / 60;

            var _timeObj = JSON.parse(JSON.stringify(timeObj));
            TimeArray.push(_timeObj);
        }

        { //tail
            timeObj.timeStamp = t2m.toLocaleTimeString();
            timeObj.value = PrevTot2 / 60;

            var _timeObj = JSON.parse(JSON.stringify(timeObj));
            TimeArray.push(_timeObj);
        }


        //process middle 
        for (let j = 0; j < minDiff; j++) {
            t1m.setTime(t1m.getTime + j * 60 * 1000);
            timeObj.timeStamp = t1m.toLocaleTimeString();
            timeObj.value = 1;

            var _timeObj = JSON.parse(JSON.stringify(timeObj));
            TimeArray.push(_timeObj);
            TimeArray.push(t1m.toLocaleTimeString(), 1);

        }


    } else { //全部标0
        // var t = new Date();
        t = t.setTime(t1m - 60 * 1000); //Previous

        let _RecordExist = false;
        let _ExistValue = 0;

        console.log(t.toLocaleTimeString());

        for (const key in timeArray) { //already exits in Array?

            if (timeArray[key].timeStamp == t.toLocaleTimeString()) {
                _RecordExist = true;
                _ExistValue = timeArray[key].Value;
            }
        }

        { //HEAD
            timeObj.timeStamp = t;
            timeObj.value = _ExistValue;

            var _timeObj = JSON.parse(JSON.stringify(timeObj));
            timeArray.push(_timeObj);
        }

        { //tail
            timeObj.timeStamp = t2m.toLocaleTimeString();
            timeObj.value = 0;

            var _timeObj = JSON.parse(JSON.stringify(timeObj));
            timeArray.push(_timeObj);
        }


        //process middle 
        for (let j = 0; j < minDiff; j++) {
            t1m.setTime(t1m.getTime + j * 60 * 1000);
            timeObj.timeStamp = t1m.toLocaleTimeString();
            timeObj.value = 0;

            var _timeObj = JSON.parse(JSON.stringify(timeObj));
            timeArray.push(_timeObj);
            timeArray.push(t1m.toLocaleTimeString(), 1);

        }


    }
}

console.log(timeArray)

//处理逻辑：一分钟切片
//每一分钟 ：12:01:00 有一个对应的占用 0-1，比如0.5 :代表50%的利用率
//算法:每一个时间戳看前一个： 当前占用-前一个占用，标记为100%
// 当前占用 前一个空闲 标记为0
// 当前空闲 均标记为0
// 标记举例 1:01.11 in 1:05:44 in
//         1:01:00 49/60 
//         1:02:00 1 
//         1:03:00 1 
//         1:04:00 1 
//         1:05:00 1 
//         标记举例 1:01.11 out 1:05:44 in
//         1:01:00 0 
//         1:02:00 0 
//         1:03:00 0 
//         1:04:00 0 
//         1:05:00 16/60